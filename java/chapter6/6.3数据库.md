# 6.3 数据库

Java通过[JDBC](https://www.mysql.com/products/connector/)连接Mysql

## 使用过程
1. 加载驱动相关的Class
2. 通过`DriverManager`和数据库uri构建`Connection`对象
3. 创建`Statement`或`PreparedStatement`执行SQL语句

```java
// 加载驱动相关的class
Class.forName("com.mysql.cj.jdbc.Driver");// 8.0以下是：com.mysql.jdbc.Driver
// 构建uri，选定 main 仓库
String uri = "jdbc:mysql://localhost:3306/main?useSSL=true&serverTimezone=UTC";
// 通过 DriverManager::getConnection 获取
Connection conn = DriverManager.getConnection(uri, "root", "0000");

/** Statement执行 **/
Statement statement = conn.createStatement();
String sql = "";
// 单条执行
boolean res = statement.execute(sql);
int cnt = statement.executeUpdate(sql);
ResultSet resSet = statement.executeQuery(sql);
// 批量执行
statement.addBatch(sql);
statement.addBatch(sql);
statement.executeBatch();

/** PreparedStatement执行 **/
// 获取预编译语句对象，可以复用
PreparedStatement preparedStatement = conn.prepareStatement(sql);
// 设置占位符的值
preparedStatement.setString(0, "value");
preparedStatement.executeUpdate();
resSet = preparedStatement.executeQuery();
```

## 结果集
在`conn.createStatement()`、`conn.createPrepareStatement()`是可通过参数指定结果集特性：
- 是否可修改数据：
    - 只读：`ResultSet.CONCUR_READ_ONLY`
    - 可写：`ResultSet.CONCUR_UPDATABLE`
- 行指针移动方式
    - 单向移动：`ResultSet.TYPE_FORWARD_ONLY`
    - 写入后读保持不变：`ResultSet.TYPE_SCROLL_INSENSITIVE`
    - 写入后读移动到写入位置：`ResultSet.TYPE_SCROLL_SENSITIVE`
- 事务提交后:
    - 保持结果集打开：`ResultSet.HOLD_CURSORS_OVER_COMMIT`
    - 关闭结果集：`ResultSet.CLOSE_CURSORS_AT_COMMIT`

### ResultSet
1. 读取数据:
    - 获取行号：`int r = resSet.getRow();`
    - 获取列号：`int c = resSet.findColumn(colName)`
    - 获取本行某列值：`String val = resSet.getString(col)`
    - 从数据库同步当前行数据：`resSet.refreshRow()`
2. 添加数据:
    - 移动到插入行（这是一个空白行）：`resSet.moveToInsertRow()`
    - 调用更新操作写入字段：`resSet.updateXXX(col, xxx)`
    - 提交插入事务：`resSet.insertRow()`
3. 提交删除事务：`resSet.deleteRow()` 
4. 修改数据：
    - 更新值：`resSet.updateXxx(col, xx)`、`resSet.updateNull(col)`
    - 取消更新：`resSet.cancelRowUpdate()`
    - 提交更新事务：`resSet.updateRow()`
5. 移动游标:
    - 绝对移动：
        - 首行/首行前：`resSet.first()`、`resSet.beforeFirst()`
        - 尾行/尾行后：`resSet.after()`、`resSet.afterLast()`
        - 具体某行：`resSet.absolute(int row)`，`row==0`同`beforeFirst()`
    - 相对移动：
        - 移动一行：`resSet.previous()`、`resSet.next()`
        - 移动N行：`resSet.relative(int rows)`，rows为正向前移动
    - 特殊位置：
        - 移动到读取行：`resSet.moveToCurrentRow()`，如果当前在插入行的话
        - 移动到插入行：`resSet.moveToInsertRow()`


```java
// create table m_books( id INT(11) primary key auto_increment, name varchar(120), code varchar(200) );
Statement statement = conn.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE, ResultSet.CONCUR_UPDATABLE);
String sql = "select * from m_books";
ResultSet resultSet = statement.executeQuery(sql);

// 插入
for (int i = 0; i < 3; i++) {
    resultSet.moveToInsertRow();
    resultSet.updateString("name", "书名" + i);
    resultSet.updateString("code", "AAAAAAA" + i);
    resultSet.insertRow();
}

// 查询
resultSet.first();
resultSet.refreshRow();
T.d(resultSet.getString("name"));

// 修改
resultSet.absolute(2);
resultSet.updateString("name", "修改书名");
resultSet.updateRow();

// 删除
resultSet.last();
resultSet.deleteRow();
```
