# 7.4 DSL支持

利用Kotlin支持拓展函数、带接收者的函数字面值 这两个特性，可便捷地构建自定义的DSL。

*注*：
DSL即领域专用语言(Domian-Specific Language)专注于特定问题领域的计算机语言(相对通用计算机语言GPL而言)；
DSL聚焦与特定问题领域，功能简单但完备，更容易理解和使用。如Gradle基于Ant和Maven，用Groovy的DSL来声明项目设置。

```kotlin
class ReqWrapper {
    var url: String = ""
    var method: String = "GET"
    var body: RequestBody = "".toRequestBody()
    var timeout = Triple(3000L, 5000L, 8000L)
    
    private var _success: (String) -> Unit = { }
    private var _fail: (Throwable) -> Unit = {}

    fun onSuccess(onSuccess: (String) -> Unit) {
        _success = onSuccess
    }

    fun onFail(onError: (Throwable) -> Unit) {
        _fail = onError
    }

    companion object {
        // 指定init函数的接收者是ReqWrapper实例
        fun creator(init: ReqWrapper.() -> Unit) {
            val wrap = ReqWrapper()
            wrap.init()
            executeForResult(wrap)
        }
        // 'org.jetbrains.kotlinx:kotlinx-coroutines-core:1.6.3'
        private fun executeForResult(wrap: ReqWrapper) = runBlocking(Dispatchers.IO) {
            if (wrap.url.isBlank()) {
                wrap._fail(IllegalArgumentException("url is empty"))
                return@runBlocking
            }
            runCatching {
                // 'com.squareup.okhttp3:okhttp:4.9.3'
                val client = OkHttpClient.Builder()
                    .connectTimeout(wrap.timeout.first, TimeUnit.MILLISECONDS)
                    .readTimeout(wrap.timeout.second, TimeUnit.MILLISECONDS)
                    .writeTimeout(wrap.timeout.third, TimeUnit.MILLISECONDS)
                    .build()
                val req = when (wrap.method) {
                    "post", "Post", "POST" -> Request.Builder().url(wrap.url).post(wrap.body).build()
                    else -> Request.Builder().url(wrap.url).build()
                }
                return@runCatching client.newCall(req).execute().body?.string() ?: ""
            }.onSuccess(wrap._success)
                .onFailure(wrap._fail)
        }
    }
}

fun main() {
    val http = ReqWrapper.Companion::creator
    http {
        url = "https://www.baidu.com"
        onSuccess {
            println(it)
        }
        onFail {
            println("request failed")
            it.printStackTrace()
        }
    }
}
```

*附*：
[kotlinx.html](https://github.com/Kotlin/kotlinx.html)分别提供了kotlinx-html-jvm和kotlinx-html-js库的DSL；
用于在JVM和浏览器/JS引擎中直接使用Kotlin代码来构建HTML，更加简洁纯净；
还能省略诸如JSP、Velocity、Freemarker等视图模板引擎直接用后端接口数据操作HTML元素。
