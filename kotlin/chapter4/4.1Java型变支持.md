# 4.1 Java型变支持
Java的泛型是不型变的，但支持在使用侧借助类型通配符完成协变和逆变。

## 类型通配符
- `? extends T` 指定类型参数的上限，该类型(`?`)必须是类型T或者它的子类型
- `? super T` 指定类型参数的下限，该类型(`?`)必须是类型T或者它的父类型
- `?` 无界通配符，代表任意未知类型

以 Cat -|> Animal 表示`class Cat: Animal`、ShepherdDog -|> Dog -|> Animal：
![Java类型通配符](../.asset/java-variance.png)

*注*：
- `List<Cat>`和`List<Animal>`不存在父子类型关系，即泛型是不型变的。
- `List<? extends Animal>`只能Get不能Put，因为不知道容器内元素的具体类型
- `List<? super ShepherdDog>`只能Put不能Get，因为Get出的元素无法引用(也不知道具体类型)
- `List<?>`能Get出Object元素，只能Put进null

## 协变
Convariant：若 C -|> F 时有 f(C) -|> f(F) 则f叫做协变，其中f(F)形如`List<F>`。
Java的数组是协变的，即`Number[] arr =  new Integer[10];` 但这样的协变并不安全：
```java
    Object[] os = new Integer[10];
    os[0] = ""; // error: ArrayStoreException
```

Java通过`? extends`上限通配符来实现协变：
`Integer` -|> `? extends Number` 且有 `List<Integer>` -|> `List<? extends Number>`
```java
    List<? extends Number> nList = new ArrayList<Integer>(Arrays.asList(1, 2, 3));
    Number n = nList.get(0); // 可以取出Number
    nList.add(null); // 只能写入null
    // nList.add(4); // error
```

## 逆协变
Contravariant：若 C -|> F 时有 f(F) -|> f(C) 则f叫做逆变, 其中f(C)指`List<C>`

Java通过`? super`下限通配符来实现逆变：
`? super Integer` -|> `Number` 且有 `List<Number>` -|> `List<? super Integer>`
```java
    List<? super Integer> nList = new ArrayList<Number>(Arrays.asList(1, 2, 3));
    Object obj = nList.get(0); // 只能取Object
    nList.add(4); // 可以写入Integer
```

*注*：
- 若协变和逆变关系都不成立，则叫做不型变。
- PECS(producer-extends, consumer-super)即Get and Put Principle，用法参见`Collections.copy()`

```java
// Collections
public static <T> void copy(List<? super T> dest, List<? extends T> src) {
    int srcSize = src.size();
    if (srcSize < 10 || src instanceof RandomAccess && dest instanceof RandomAccess) {
        for (int i = 0; i < srcSize; ++i) dest.set(i, src.get(i));
    } else {
        ListIterator<? super T> di = dest.listIterator(); // in T
        ListIterator<? extends T> si = src.listIterator(); // out T
        for (int i = 0; i < srcSize; ++i) {
            di.next();
            di.set(si.next());
        }
    }
}
```

